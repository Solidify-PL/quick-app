name: Release

on:
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}   # jeden "grupowy lock" na branch
  cancel-in-progress: true           # anuluje buildy w toku

jobs:
  maven-compile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set up GraalVM (latest stable)
        uses: actions/setup-java@v4
        with:
          distribution: graalvm
          java-version: 21
          cache: maven

      - name: Print environment info
        run: |
          echo "OS: $(uname -s)"
          echo "ARCH: $(uname -m)"
          echo "JAVA_HOME: $JAVA_HOME"
          java -version

      - name: Maven compile
        run: mvn -B compile

      - name: Maven unit tests
        run: mvn -B test

      - name: Maven integration tests (Failsafe)
        run: mvn -B test-compile failsafe:integration-test failsafe:verify

  build-jars:
    needs: maven-compile
    runs-on: ubuntu-latest

    outputs:
      release_version: ${{ steps.get_version.outputs.release_version }}
      dev_version: ${{ steps.get_version.outputs.dev_version }}

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version from pom.xml
        id: get_version
        shell: bash
        run: |
          # Get current version from pom.xml (e.g., "0.5-SNAPSHOT")
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)

          # Remove -SNAPSHOT to get base version (e.g., "0.5")
          BASE_VERSION=$(echo "$CURRENT_VERSION" | sed 's/-SNAPSHOT$//')

          # Split version into components and increment the last one
          IFS='.' read -ra VERSION_PARTS <<< "$BASE_VERSION"
          LAST_INDEX=$((${#VERSION_PARTS[@]} - 1))
          VERSION_PARTS[$LAST_INDEX]=$((${VERSION_PARTS[$LAST_INDEX]} + 1))

          # Construct next development version (e.g., "0.6-SNAPSHOT")
          NEXT_DEV_VERSION=$(IFS='.'; echo "${VERSION_PARTS[*]}")-SNAPSHOT
          echo "dev_version=$NEXT_DEV_VERSION" >> $GITHUB_OUTPUT


          RELEASE_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout | sed 's/-SNAPSHOT$//')
          # Add .0 patch version if version has only two components
          if [[ $(echo "$RELEASE_VERSION" | grep -o '\.' | wc -l) -eq 1 ]]; then
            RELEASE_VERSION="${RELEASE_VERSION}.0"
          fi
          echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT

      - name: Generate Changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: >
            --latest
            --tag v${{ needs.build-jars.outputs.release_version }}
            --output changelog.md

      - name: Prepare & Perform Release
        env:
          GITREPO_ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JAVA_HOME: /usr/lib/jvm/java-21-openjdk/
        uses: qcastel/github-actions-maven-release@70725f21eb1049fbf049470e72efbcd5d1528f35
        with:
          maven-release-version-number: ${{ steps.get_version.outputs.release_version }}
          maven-development-version-number: ${{ steps.get_version.outputs.dev_version }}
          maven-servers: |
            [
              {
                "id": "maven-releases",
                "username": "${{ secrets.NEXUS_USERNAME }}",
                "password": "${{ secrets.NEXUS_PASSWORD }}"
              }
            ]

      - name: Publish changelog
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create v${{ steps.get_version.outputs.release_version }} --notes-file changelog.md

      - name: create branch for patches
        if: github.ref == 'refs/heads/master'
        run: |
          sudo chown -R $(whoami) .git
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          git fetch origin

          RELEASE_VERSION="${{ steps.get_version.outputs.release_version }}"
          MAJOR_MINOR=$(echo "$RELEASE_VERSION" | sed -E 's/\.[0-9]+$//')
          BRANCH_NAME="v${MAJOR_MINOR}.x"

          git checkout -b "$BRANCH_NAME" HEAD~1

          PATCH_VERSION="${MAJOR_MINOR}.1-SNAPSHOT"
          mvn versions:set -DnewVersion="$PATCH_VERSION" -DgenerateBackupPoms=false -DprocessAllModules=true

          git commit -am "Set version to $PATCH_VERSION for patch branch"

          git push origin "$BRANCH_NAME"
          git checkout master


  build-native:
    needs: [ maven-compile, build-jars ]

    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm

          # Windows (amd64 only)
          - os: windows
            arch: amd64
            runner: windows-latest

          # macOS (Apple Silicon only)
          - os: macos
            arch: arm64
            runner: macos-14

    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set up GraalVM (latest stable)
        uses: actions/setup-java@v4
        with:
          distribution: graalvm
          java-version: 21
          cache: maven

      - name: Print matrix values
        run: |
          echo "OS:     ${{ matrix.os }}"
          echo "ARCH:   ${{ matrix.arch }}"
          echo "RUNNER: ${{ matrix.runner }}"
          mvn package -DskipTests -DskipIntegrationTests -P native,${{ matrix.os }}-${{ matrix.arch }}

      - name: Prepare binary for upload
        shell: bash
        run: |
          if [ "${{ matrix.os }}" == "windows" ]; then
            cp qa-ctl/target/qa.exe qa-${{ matrix.os }}-${{ matrix.arch }}.exe
          else
            cp qa-ctl/target/qa qa-${{ matrix.os }}-${{ matrix.arch }}
          fi

      - name: Compress binaries
        shell: bash
        run: |
          if [ "${{ matrix.os }}" == "windows" ]; then
            7z a -tzip qa-${{ matrix.os }}-${{ matrix.arch }}.zip qa-${{ matrix.os }}-${{ matrix.arch }}.exe
          else
            tar -czf qa-${{ matrix.os }}-${{ matrix.arch }}.tar.gz qa-${{ matrix.os }}-${{ matrix.arch }}
          fi

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.build-jars.outputs.release_version }}
          draft: false
          prerelease: false
          files: |
            qa-${{ matrix.os }}-${{ matrix.arch }}.tar.gz
            qa-${{ matrix.os }}-${{ matrix.arch }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

